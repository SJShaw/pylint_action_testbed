name: "Check for unwanted files"

on: [pull_request]

jobs:
  file_existence:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout changes
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          path: changes

      - name: Checkout default branch's .gitignore
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.repository.default_branch }}
          path: original
          sparse-checkout: .gitignore

      - name: Check for unwanted files
        run: |
          set +e
          cp original/.gitignore changes/.gitignore
          cd changes
          ignored_files=$(git ls-files -ci --exclude-standard | grep -ve ^docker/ -ve /test/)

          if [ ! -z "$ignored_files" ]; then
            echo "::error:: Deliberately ignored files were included:"
            echo $ignored_files
            exit 1
          fi
        shell: bash
